INSTALL ZIP: C:\p\c++\patch\v14_fastaccelstepper_only_patch.zip
TIME: 2026-02-23 02:35:24
TARGET_ROOT: C:\p\c++\vPlotterV1
DEST (DEST_SUBDIR): C:\p\c++\vPlotterV1
VERSION:  PATCH_ID: 
INSTALL_TXT: INSTALL.txt
BACKUP_ENABLED: True
BACKUP_ZIP: C:\p\c++\backup\backup_vPlotterV1_vnone_none_20260223_023509.zip
PRECHECK: replace=4 add=1 total=5

--- DIFF (line numbers) src/movement.h ---
HUNK old 169-177  new 169-174
- old:   172 
- old:   173     // Planner smoothing state. Keeps behaviour stable while allowing lookaheadSegments to matter.
- old:   174     double lastCornerFactor = 1.0;
HUNK old 195-201  new 192-198
- old:   198     double computeCornerFactor(double dx, double dy, double requestedSpeedSteps);
+ new:   195     double computeCornerFactor(double dx, double dy) const;

--- DIFF (line numbers) src/stepper_backend.h ---
HUNK old 2-32  new 2-8
- old:     5 
- old:     6 // Backend selector:
- old:     7 // - When USE_FAST_ACCELSTEPPER is defined (e.g. via build flag -DUSE_FAST_ACCELSTEPPER=1),
- old:     8 //   the project uses FastAccelStepper (high speed, hardware driven).
- old:     9 // - Otherwise it uses AccelStepper (existing behaviour).
- old:    10 #ifndef USE_FAST_ACCELSTEPPER
- old:    11 #define USE_FAST_ACCELSTEPPER 0
- old:    12 #endif
- old:    13 
- old:    14 // Be defensive: if the library is not installed but the flag is set, fall back to AccelStepper.
- old:    15 // This prevents "it builds on my machine" surprises.
- old:    16 #if USE_FAST_ACCELSTEPPER
- old:    17   #if __has_include(<FastAccelStepper.h>)
- old:    18     #include <FastAccelStepper.h>
- old:    19     #define STEPPER_BACKEND_HAS_FAST 1
- old:    20   #else
- old:    21     #include <AccelStepper.h>
- old:    22     #define STEPPER_BACKEND_HAS_FAST 0
- old:    23     #undef USE_FAST_ACCELSTEPPER
- old:    24     #define USE_FAST_ACCELSTEPPER 0
- old:    25   #endif
- old:    26 #else
- old:    27   #include <AccelStepper.h>
- old:    28   #define STEPPER_BACKEND_HAS_FAST 0
- old:    29 #endif
+ new:     5 #include <FastAccelStepper.h>
HUNK old 47-65  new 23-41
- old:    50   // optional enable pin wiring (recommended for FastAccelStepper)
+ new:    26   // optional enable pin wiring
- old:    53   virtual void run() = 0;                                // called in loop for AccelStepper; no-op for FastAccelStepper
+ new:    29   // called from loop; FastAccelStepper runs autonomously (no-op)
+ new:    30   virtual void run() = 0;
+ new:    31 
- old:    58   // Pulse width (AccelStepper only). FastAccelStepper generates its own pulses (few Âµs) and does not expose setMinPulseWidth.
+ new:    36   // Pulse width is not configurable with FastAccelStepper. Keep API as no-op for compatibility.
- old:    61 
- old:    62 #if USE_FAST_ACCELSTEPPER
HUNK old 96-138  new 72-78
- old:    99   // We track target, because FastAccelStepper does not expose target position in a lightweight call.
- old:   103 #else
- old:   104 
- old:   105 class AccelStepperBackend final : public StepperBackend {
- old:   106 public:
- old:   107   AccelStepperBackend(uint8_t stepPin, uint8_t dirPin);
- old:   108 
- old:   109   void setPinsInverted(bool dirInvert) override;
- old:   110 
- old:   111   void setMaxSpeed(float stepsPerSecond) override;
- old:   112   void setAcceleration(float stepsPerSecond2) override;
- old:   113 
- old:   114   void setSpeed(float stepsPerSecond) override;
- old:   115   void move(long relativeSteps) override;
- old:   116   void moveTo(long absoluteSteps) override;
- old:   117   void stop() override;
- old:   118 
- old:   119   void enableOutputs() override;
- old:   120   void disableOutputs() override;
- old:   121 
- old:   122   void configureEnablePin(int enablePin, bool enableActiveLow) override;
- old:   123 
- old:   124   void run() override;
- old:   125 
- old:   126   long distanceToGo() const override;
- old:   127   long currentPosition() const override;
- old:   128   void setCurrentPosition(long pos) override;
- old:   129 
- old:   130   void setMinPulseWidth(unsigned int us) override;
- old:   131 
- old:   132 private:
- old:   133   AccelStepper _stepper;
- old:   134 };
- old:   135 
- old:   136 #endif
- old:   137 

--- DIFF (line numbers) src/movement.cpp ---
HUNK old 5-11  new 5-10
- old:     8 #include <algorithm>
HUNK old 13-34  new 12-26
- old:    16     #if USE_FAST_ACCELSTEPPER
+ new:    15         // Always use FastAccelStepper backend
- old:    18 #else
- old:    19     leftMotor = new AccelStepperBackend(LEFT_STEP_PIN, LEFT_DIR_PIN);
- old:    20 #endif
- old:    27 #if USE_FAST_ACCELSTEPPER
- old:    29 #else
- old:    30     rightMotor = new AccelStepperBackend(RIGHT_STEP_PIN, RIGHT_DIR_PIN);
- old:    31 #endif
HUNK old 100-145  new 92-124
- old:   103     // Manual jog: must work regardless of last planned move.
- old:   104     // run() uses MaxSpeed/Acceleration, so set them explicitly here.
- old:   105     if (!leftMotor) return;
- old:   106 
- old:   107     leftMotor->enableOutputs();
- old:   108     leftMotor->setAcceleration((float)accelerationSteps);
- old:   109     leftMotor->setMaxSpeed((float)printSpeedSteps);
- old:   110 
+ new:    97         leftMotor->setSpeed(printSpeedSteps);
+ new:   100         leftMotor->setSpeed(printSpeedSteps);
+ new:   102         leftMotor->setAcceleration((float)accelerationSteps);
- old:   118 
- old:   122 
- old:   124     // Manual jog: must work regardless of last planned move.
- old:   125     // run() uses MaxSpeed/Acceleration, so set them explicitly here.
- old:   126     if (!rightMotor) return;
- old:   127 
- old:   128     rightMotor->enableOutputs();
- old:   129     rightMotor->setAcceleration((float)accelerationSteps);
- old:   130     rightMotor->setMaxSpeed((float)printSpeedSteps);
- old:   131 
+ new:   111         rightMotor->setSpeed(printSpeedSteps);
+ new:   114         rightMotor->setSpeed(printSpeedSteps);
+ new:   116         rightMotor->setAcceleration((float)accelerationSteps);
+ new:   117         rightMotor->setMinPulseWidth(_rightPulseWidthUs);
- old:   139 
- old:   142 
HUNK old 250-259  new 229-236
- old:   253     // Higher precision is important when we segment moves into many small XY steps.
- old:   254     // Too-loose termination accumulates visible curvature on long straight lines.
- old:   255     constexpr int solver_max_iterations = 60;
- old:   256     constexpr double gamma_delta_termination = 0.05 / 180.0 * PI;
+ new:   232     constexpr int solver_max_iterations = 20;
+ new:   233     constexpr double gamma_delta_termination = 0.25 / 180.0 * PI;
HUNK old 262-268  new 239-245
- old:   265         if (fabs(gamma_last - gamma) < gamma_delta_termination) break;
+ new:   242         if (abs(gamma_last - gamma) < gamma_delta_termination) break;
HUNK old 283-338  new 260-280
- old:   286 double Movement::computeCornerFactor(double dx, double dy, double requestedSpeedSteps) {
+ new:   263 double Movement::computeCornerFactor(double dx, double dy) const {
- old:   291     // Very small segments should not be corner-limited again.
- old:   292     if (plannerCfg.minSegmentLenMM > 0.0) {
- old:   293         const double lenMm = (double)len / (double)std::max(1, mmToSteps(1.0));
- old:   294         if (lenMm < plannerCfg.minSegmentLenMM) return 1.0;
- old:   295     }
- old:   296 
- old:   300     // Collinear simplification: if almost straight, don't corner-limit.
- old:   301     if (plannerCfg.collinearDeg > 0.0) {
- old:   302         const double angleDeg = angle * 180.0 / PI;
- old:   303         if (angleDeg < plannerCfg.collinearDeg) return 1.0;
- old:   304     }
- old:   305 
- old:   308     // Base slowdown (legacy behaviour)
+ new:   273     // Junction-deviation style simple scaler
- old:   312 
- old:   313     // Junction-deviation limit: convert corner angle into a max junction speed and clamp by requested speed.
- old:   314     // This makes junctionDeviationMM actually matter.
- old:   315     if (plannerCfg.junctionDeviationMM > 0.0 && requestedSpeedSteps > 1.0) {
- old:   316         const double sinHalf = sin(angle * 0.5);
- old:   317         const double denom = 1.0 - sinHalf;
- old:   318         if (sinHalf > 1e-6 && denom > 1e-6) {
- old:   319             const double jdSteps = (double)std::max(1, mmToSteps(plannerCfg.junctionDeviationMM));
- old:   320             const double a = ((double)accelerationSteps < 1.0) ? 1.0 : (double)accelerationSteps;
- old:   321             const double vJ = sqrt((a * jdSteps * sinHalf) / denom);
- old:   322             double jdFactor = vJ / requestedSpeedSteps;
- old:   323             if (jdFactor < 0.05) jdFactor = 0.05;
- old:   324             if (jdFactor > 1.0) jdFactor = 1.0;
- old:   325             if (jdFactor < f) f = jdFactor;
- old:   326         }
- old:   327     }
- old:   328 
- old:   329     // Simple lookahead smoothing: higher lookaheadSegments => smoother factor changes.
- old:   330     int n = plannerCfg.lookaheadSegments;
- old:   331     if (n < 1) n = 1;
- old:   332     if (n > 200) n = 200;
- old:   333     const double alpha = 1.0 / (double)std::max(1, n / 8);
- old:   334     lastCornerFactor = lastCornerFactor + alpha * (f - lastCornerFactor);
- old:   335     return lastCornerFactor;
+ new:   277     return f;
HUNK old 379-385  new 321-327
- old:   382     double cornerFactor = computeCornerFactor(dx, dy, (double)speed);
+ new:   324     double cornerFactor = computeCornerFactor(dx, dy);

--- DIFF (line numbers) src/stepper_backend.cpp ---
HUNK old 1-6  new 1-5
- old:     3 #if USE_FAST_ACCELSTEPPER
HUNK old 112-184  new 111-113
- old:   115 #else
- old:   116 
- old:   117 AccelStepperBackend::AccelStepperBackend(uint8_t stepPin, uint8_t dirPin)
- old:   118   : _stepper(AccelStepper::DRIVER, stepPin, dirPin) {}
- old:   119 
- old:   120 void AccelStepperBackend::setPinsInverted(bool dirInvert) {
- old:   121   _stepper.setPinsInverted(dirInvert);
- old:   122 }
- old:   123 
- old:   124 void AccelStepperBackend::setMaxSpeed(float stepsPerSecond) {
- old:   125   _stepper.setMaxSpeed(stepsPerSecond);
- old:   126 }
- old:   127 
- old:   128 void AccelStepperBackend::setAcceleration(float stepsPerSecond2) {
- old:   129   _stepper.setAcceleration(stepsPerSecond2);
- old:   130 }
- old:   131 
- old:   132 void AccelStepperBackend::setSpeed(float stepsPerSecond) {
- old:   133   _stepper.setSpeed(stepsPerSecond);
- old:   134 }
- old:   135 
- old:   136 void AccelStepperBackend::move(long relativeSteps) {
- old:   137   _stepper.move(relativeSteps);
- old:   138 }
- old:   139 
- old:   140 void AccelStepperBackend::moveTo(long absoluteSteps) {
- old:   141   _stepper.moveTo(absoluteSteps);
- old:   142 }
- old:   143 
- old:   144 void AccelStepperBackend::stop() {
- old:   145   _stepper.stop();
- old:   146 }
- old:   147 
- old:   148 void AccelStepperBackend::enableOutputs() {
- old:   149   _stepper.enableOutputs();
- old:   150 }
- old:   151 
- old:   152 void AccelStepperBackend::disableOutputs() {
- old:   153   _stepper.disableOutputs();
- old:   154 }
- old:   155 
- old:   156 void AccelStepperBackend::configureEnablePin(int enablePin, bool enableActiveLow) {
- old:   157   if (enablePin < 0) return;
- old:   158   // AccelStepper enable pin: LOW disables by default unless inverted.
- old:   159   _stepper.setEnablePin(enablePin);
- old:   160   // If enable is active LOW, we invert the enable logic.
- old:   161   _stepper.setPinsInverted(false, false, enableActiveLow);
- old:   162 }
- old:   163 
- old:   164 void AccelStepperBackend::run() {
- old:   165   _stepper.run();
- old:   166 }
- old:   167 
- old:   168 long AccelStepperBackend::distanceToGo() const {
- old:   169   return _stepper.distanceToGo();
- old:   170 }
- old:   171 
- old:   172 long AccelStepperBackend::currentPosition() const {
- old:   173   return _stepper.currentPosition();
- old:   174 }
- old:   175 
- old:   176 void AccelStepperBackend::setCurrentPosition(long pos) {
- old:   177   _stepper.setCurrentPosition(pos);
- old:   178 }
- old:   179 
- old:   180 void AccelStepperBackend::setMinPulseWidth(unsigned int us) {
- old:   181   _stepper.setMinPulseWidth(us);
- old:   182 }
- old:   183 
- old:   184 #endif

CHANGELOG: C:\p\c++\vPlotterV1\CHANGELOG_unknown_20260223_023524.md
INSTALL DONE
